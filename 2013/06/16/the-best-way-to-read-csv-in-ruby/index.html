<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>The Best Way to Read CSV in Ruby</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="A tech blog about ruby, code, mongodb, golang and other stuff.">
    <link rel="canonical" href="http://squarism.com//2013/06/16/the-best-way-to-read-csv-in-ruby/">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/">Squarism</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          <a class="page-link" href="/about/">About</a>
        
          
        
          
        
          <a class="page-link" href="/about/index.html">About</a>
        
          <a class="page-link" href="/questions/index.html">Questions I Have</a>
        
          <a class="page-link" href="/tatris/index.html">Tatris - A Tetris Clone</a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>The Best Way to Read CSV in Ruby</h1>
    <p class="meta">Jun 16, 2013 â€¢ Posted by: chris</p>
  </header>

  <article class="post-content">
  <p><img src="/uploads/2013/06/pixel-ribbon_company_profile.png" alt="pixel-ribbon_company_profile" width="576" height="24" class="aligncenter size-full wp-image-2014" /></p>
<p>CSV is awful.  CSV isn't well formed.  It isn't hard to use because it's bloated and slow.  CSV is hard to use because it's just a dumb data format.  However, sometimes all you have is stupid data and <em>who cares, let's do this thing and blot out the memories</em>.</p>
<p>I assume you know how to use the CSV module that's built into Ruby.  It's pretty easy.  You just read a file in and you get some 2D array back.  It usually comes out pretty horrible with long methods and little room for nice abstractions.</p>
<p>So what if you want to polish it up a little bit?  Maybe you aren't just going to kludge this thing again and hate yourself later?  What if you aren't just going to load this into a database?  What if you want to do some quick CSV analysis but at the same time make it come out sort of readable?</p>
<p>Let's take a look at an abstraction layer and see how we could write a CSV loader for a guest list.  We're going to have a dinner party and evite gave us a crappy CSV dump of who's responded so far.  Well, it's what we have.  But how many people are coming and how many groups aren't allergic to peanuts?  We want to know how many peanut M&amp;Ms to buy.</p>
<p>Here's our data:</p>
<pre>
Name, Plus, RSVP'd, Peanut Allergies<br />
Tom DeLuise, 1, No, Yes<br />
Mel Brooks, 3, Yes, Yes<br />
Lewis Black, 5, Yes, No<br />
Jon Stewart, 3, Yes, Yes<br />
Jim Gaffigan, 0, Yes, No<br />
</pre>
<p>&lt;/p&gt;</p>
<p>Supermodel is pretty old and I like it a lot but it hasn't been updated in a while and has some open pull requests.  I took at look at some alternatives but it didn't work out.<br />
- ActiveModel from Rails 3 is hard to make generic<br />
- ActiveModel::Model from Rails 4 is a great upgrade from 3.x.  You can  make anything look like a database object but it still doesn't have the concept of a collection.  So now I have to make an array variable called table?  This is weird.<br />
- Sequel has a nice interface to an in-memory sqlite3 database.  It's probably the most 'real' that I found but it requires you to do a CREATE TABLE statement even for your in-memory database.</p>
<p>None of these alternatives above are bad but let's take a look and see how nice we can get it with Supermodel.</p>
<p>First, we are going to use a supermodel fork so that we automatically get rails 3.2.13 instead of 3.0.x.  Create a project folder and a Gemfile file:</p>
<pre lang="ruby">
source "https://rubygems.org"
<p>gem 'supermodel', :git =&gt; 'https://github.com/amdtech/supermodel.git'<br />
</p>
<p>Run bundle.</p>
<pre lang="ruby">
require 'csv'<br />
require 'supermodel'
<p>class Guest &lt; SuperModel::Base<br />
  validates_presence_of :name<br />
end</p>
<p>class CSVImporter<br />
  def import filename<br />
    csv = CSV.read(File.open(filename))<br />
    remove_headers csv</p>
<p>    csv.each do |row|<br />
      Guest.create attributes_for(row)<br />
    end<br />
  end</p>
<p>  # i know i've gotten this to work more elegantly<br />
  def remove_headers csv<br />
    csv.delete_at 0<br />
  end</p>
<p>  def attributes_for row<br />
    row = strip_row!(row)<br />
    {<br />
      name:             row[0],<br />
      plus:             row[1].to_i,<br />
      rsvp:             row[2] == "Yes",<br />
      peanut_allergies: row[3] == "Yes"<br />
    }<br />
  end</p>
<p>  def strip_row!(row)<br />
    row.collect {|cell| cell.strip }<br />
  end<br />
end</p>
<p>CSVImporter.new.import('guests.csv')</p>
<p>puts "How many people are coming?"<br />
puts Guest.all.reduce(0) {|sum, guest| sum += guest.plus + 1}</p>
<p>peanut_eating_guests = Guest.all.select {|guest| guest.peanut_allergies == false }<br />
peanut_guest_count = peanut_eating_guests.inject(0) {|sum, guest| sum += guest.plus + 1 }<br />
puts "Number of guests eating peanut M&amp;Ms:"<br />
puts peanut_guest_count</p>
<p># How many people are coming?<br />
# 17<br />
# Number of guests eating peanut M&amp;Ms:<br />
# 7</p>
<p></p>
<p>You can see that Guest.all is much more intent revealing than manipulating a 2D array by hand.</p>
</pre></pre>

  </article>

</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">Squarism</h2>

    <div class="footer-col-1 column">
      <ul>
        <li>Squarism</li>
        <li><a href="mailto:squarism@gmail.com">squarism@gmail.com</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/squarism">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username">squarism</span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/squarism">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username">squarism</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">A tech blog about ruby, code, mongodb, golang and other stuff.</p>
    </div>

  </div>

</footer>


    </body>
</html>
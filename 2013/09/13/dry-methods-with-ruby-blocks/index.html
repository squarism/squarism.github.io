<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>DRY up Methods with Ruby Blocks</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="A tech blog about ruby, code, mongodb, golang and other stuff.">
    <link rel="canonical" href="http://squarism.com//2013/09/13/dry-methods-with-ruby-blocks/">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/">Squarism</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          <a class="page-link" href="/about/">About</a>
        
          
        
          
        
          <a class="page-link" href="/about/index.html">About</a>
        
          <a class="page-link" href="/questions/index.html">Questions I Have</a>
        
          <a class="page-link" href="/tatris/index.html">Tatris - A Tetris Clone</a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>DRY up Methods with Ruby Blocks</h1>
    <p class="meta">Sep 13, 2013 • Posted by: chris</p>
  </header>

  <article class="post-content">
  <p><img src="http://squarism.com/wp-content/uploads/2013/09/pixel-ribbon_redolution.png" alt="pixel-ribbon_redolution" width="576" height="24" class="aligncenter size-full wp-image-2108" /></p>
<p>Let's do something terrible by hand.  First, here's our data.  It comes from a database.</p>
<pre lang="ruby">
db_results = [<br />
  { id: 1, login: 'mjay', roles: ['user'], projects: ['muffins'] },<br />
  { id: 2, login: 'rroke', roles: ['admin', 'user'], projects: ['security'] },<br />
  { id: 3, login: 'tpain', roles: ['user'], projects: ['muffins'] },<br />
  { id: 4, login: 'ghaz', roles: ['admin', 'user'], projects: ['muffins', 'cakes'] },<br />
  { id: 5, login: 'bbarker', roles: ['user'], projects: ['pies'] }<br />
]<br />
</pre>
<p>&lt;/p&gt;</p>
<p>Now when working with these people, we probably could get away with doing something like this for a while:</p>
<pre lang="ruby">
# find all admins<br />
admins = db_results.select {|user| user[:roles].include? 'admin' }<br />
</pre>
<p>&lt;/p&gt;</p>
<p>Which is fine.  Until you want to find out what people are on the Muffin Project:</p>
<pre lang="ruby">
# find all people working on the muffins project<br />
people_on_muffins = db_results.select {|user| user[:projects].include? 'muffins' }<br />
</pre>
<p>&lt;/p&gt;</p>
<p>But as you keep working, you might be getting a feeling of deja-vu.  The two methods above are very similar.  You might be inspired by other Ruby libraries which give you a tiny DSL or at least allow you to pass blocks into methods to be more expressive.</p>
<h2>The Smell</h2>
<p><br />
Here’s the complete code smelly example.&lt;/p&gt;
&lt;pre lang="ruby"&gt;
db_results = [<br />
  { id: 1, login: ‘mjay’, roles: [‘user’], projects: [‘muffins’] },<br />
  { id: 2, login: ‘rroke’, roles: [‘admin’, ‘user’], projects: [‘security’] },<br />
  { id: 3, login: ‘tpain’, roles: [‘user’], projects: [‘muffins’] },<br />
  { id: 4, login: ‘ghaz’, roles: [‘admin’, ‘user’], projects: [‘muffins’, ‘cakes’] },<br />
  { id: 5, login: ‘bbarker’, roles: [‘user’], projects: [‘pies’] },<br />
]&lt;/p&gt;</p>
<p>admins = db_results.select {|user| user[:roles].include? 'admin' }<br />
people_on_muffins = db_results.select {|user| user[:projects].include? 'muffins' }<br />
meeting = admins + people_on_muffins<br />
meeting_ids = meeting.collect {|user| user[:login] }.uniq</p>
<p>puts meeting_ids<br />
# =&gt; rroke ghaz mjay tpain<br />
</p>
<p>We're having a meeting between the admins and people who are on the Muffin Project.  The only person not matching these rules in this case is Bob Barker (bbarker).  He must be busy enjoying retirement eating pie, who knows.</p>
<h2>Inspiration</h2>
<p><br />
Let’s take a look at Faraday.  Faraday uses blocks to great effect to communicate intent just like most libraries in Ruby.  In Faraday, this is how a HTTP POST is done using Faraday:&lt;/p&gt;
&lt;pre lang="ruby"&gt;
conn.post do |req|<br />
  req.url ‘/nigiri’<br />
  req.headers[‘Content-Type’] = ‘application/json’<br />
  req.body = ‘{ “name”: “Unagi” }’<br />
end<br />
&lt;/pre&gt;<br />
This is kind of nice!  You can get more than one thing done at a time and it doesn’t require a lot of temporary variables.  Let’s see if we can use blocks like this.  We’ll get to blocks in a miniute.  Let’s first refactor a little bit first.&lt;/p&gt;</p>
<h2>The Fix</h2>
<p><br />
There’s a certain similarity between the two selects.  We really want to get “admins” and “project people” all together, so let’s just do that.  We’ll create two methods that essentially replace the instance methods but can be used in the future for other rules.  We’ll call them .with_roles and .with_projects.&lt;/p&gt;
&lt;pre lang="ruby"&gt;
def with_roles(results, role)<br />
  results.select {|user| user[:roles].include? role }<br />
end&lt;/p&gt;</p>
<p>def with_projects(results, project)<br />
  results.select {|user| user[:projects].include? project }<br />
end<br />
</p>
<p>Next, we'll create a method that takes a block.</p>
<pre lang="ruby">
def user_ids(results, &amp;block)<br />
  rows = yield block<br />
  ids = rows.collect {|user| user[:login] } if rows<br />
  ids.uniq<br />
end<br />
</pre>
<p>&lt;/p&gt;</p>
<p>The &amp;block argument and yield block is optional.  You could write this as:</p>
<pre lang="ruby">
 def user_ids(results)<br />
   rows = results.dup<br />
   rows = yield if block_given?<br />
   ids = rows.collect {|user| user[:login] }<br />
   ids.uniq<br />
 end<br />
</pre>
<p><br />
But in that case, the block is optional, so you’ll want to check for block_given?.  For this example, it’s easier for us to require a block to make this a shorter post … err, well I guess it’s longer now.&lt;/p&gt;</p>
<p>In any event, this method's job is to filter results (users) with whatever code is passed in.  Then it uniques the collected array because user IDs are assumed here to be unique.  Finally, it returns just user_ids like it's name implies.</p>
<p>The usage of this user_ids method that takes a block ends up reading very well.</p>
<pre lang="ruby">
admins = user_ids(db_results) do<br />
  with_roles(db_results, 'admin') +<br />
  with_projects(db_results, 'muffins')<br />
end
<p>puts admins<br />
# =&gt; rroke ghaz mjay tpain<br />
</p>
<p>Here's the completed, less smelly example.</p>
<pre lang="ruby">
db_results = [<br />
  { id: 1, login: 'mjay', roles: ['user'], projects: ['muffins'] },<br />
  { id: 2, login: 'rroke', roles: ['admin', 'user'], projects: ['security'] },<br />
  { id: 3, login: 'tpain', roles: ['user'], projects: ['muffins'] },<br />
  { id: 4, login: 'ghaz', roles: ['admin', 'user'], projects: ['muffins', 'cakes'] },<br />
  { id: 5, login: 'bbarker', roles: ['user'], projects: ['pies'] }<br />
]
<p>def with_roles(results, role)<br />
  results.select {|user| user[:roles].include? role }<br />
end</p>
<p>def with_projects(results, project)<br />
  results.select {|user| user[:projects].include? project }<br />
end</p>
<p>def user_ids(results)<br />
  rows = results.dup<br />
  rows = yield if block_given?<br />
  ids = rows.collect {|user| user[:login] }<br />
  ids.uniq<br />
end</p>
<p>admins = user_ids(db_results) do<br />
  with_roles(db_results, 'admin') +<br />
  with_projects(db_results, 'muffins')<br />
end</p>
<p>puts admins<br />
# =&gt; rroke ghaz mjay tpain</p>
<p># usage without a block, showing that it's a little more flexible<br />
# puts user_ids(db_results)<br />
# =&gt; returns everyone because no filtering block was passed<br />
</p>
<h2>Wrap Up</h2>
<p>This is pretty procedural.  I'll leave it to you to put it into a class, maybe add something better than a "plus" operator to combine the user list together.  Maybe a UserList abstraction class could help get away from hashes too.</p>
<p>I like going down these paths because you end up with more expressive code that is flexible to change.  At the same time, little hints of DSLs come out when using blocks to this effect.  This is starting down the path of a Ruby DSL. I'll be posting about that pretty soon.</p>
</pre></pre>

  </article>

</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">Squarism</h2>

    <div class="footer-col-1 column">
      <ul>
        <li>Squarism</li>
        <li><a href="mailto:squarism@gmail.com">squarism@gmail.com</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/squarism">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username">squarism</span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/squarism">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username">squarism</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">A tech blog about ruby, code, mongodb, golang and other stuff.</p>
    </div>

  </div>

</footer>


    </body>
</html>
<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Debugging Cucumber and Rails</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="A tech blog about ruby, code, mongodb, golang and other stuff.">
    <link rel="canonical" href="http://squarism.com//2010/12/06/debugging-cucumber-and-rails/">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/">Squarism</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          <a class="page-link" href="/about/">About</a>
        
          
        
          
        
          <a class="page-link" href="/about/index.html">About</a>
        
          <a class="page-link" href="/questions/index.html">Questions I Have</a>
        
          <a class="page-link" href="/tatris/index.html">Tatris - A Tetris Clone</a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Debugging Cucumber and Rails</h1>
    <p class="meta">Dec 6, 2010 • Posted by: chris</p>
  </header>

  <article class="post-content">
  <p><img src="http://squarism.com/wp-content/uploads/2010/12/cucumber_green.png" alt="" title="cucumber_green" width="635" height="61" class="aligncenter size-full wp-image-800" /><br />
I was working on my <a href="http://squarism.com/2010/08/27/stream-of-thoughthose-game-store/">game store</a> app and I had some TDD things I wanted to finish up before creating a rails3 branch.  I discuss it kind of randomly in that post linked there.  I had left it to languish because I got stuck and frustrated with cucumber.  My app was working but the tests were failing (false negative).  The biggest problem was trying to understand how to debug a cucumber step.</p>
<p>The first problem is logging.  When cucumber runs webrat as a mock browser, I really expected to see the traffic in the server log (script/server).  But it didn't.  Nothing.  No traffic at all.  The second problem was seeing what the browser sees.  It was reporting back that my login was failing.   The third problem is the problem itself.  It was saying "invalid login".  I am using factorygirl to create mock users on the fly and authlogic for the authentication and so there was a possibility that something was wrong there.</p>
<h2>Logging</h2>
<p><br />
<img src="http://squarism.com/wp-content/uploads/2010/12/cucumber_console-249x300.png" alt="" title="cucumber_console" width="249" height="300" class="alignright size-medium wp-image-804" />So let’s go through this in order.  First the log problem.  The traffic I was not seeing in the script/server console was kind of confusing.  Cucumber’s traffic is actually redirected to log/cucumber.log.  So you can either tail -f that log or use the OSX console app (screenshot) to watch cucumber.log.  Either way, the traffic and any puts or STDOUT text will be there.  It’s pretty odd actually.  I don’t know how they pull this off.  The dev server (script/server) doesn’t even need to be running for the cucumber steps to work.  See below, I stopped the server and ran the tests successfully:&lt;/p&gt;</p>
<p><code>box:game_store chris$ script/server<br />
=&gt; Booting WEBrick<br />
=&gt; Rails 2.3.8 application starting on http://0.0.0.0:3000<br />
=&gt; Call with -d to detach<br />
=&gt; Ctrl-C to shutdown server<br />
[2010-12-05 00:21:34] INFO  WEBrick 1.3.1<br />
[2010-12-05 00:21:34] INFO  ruby 1.8.7 (2010-08-16) [i686-darwin10.4.0]<br />
[2010-12-05 00:21:34] INFO  WEBrick::HTTPServer#start: pid=23554 port=3000<br />
^C[2010-12-05 14:38:43] INFO  going to shutdown ...<br />
[2010-12-05 14:38:43] INFO  WEBrick::HTTPServer#start done.<br />
Exiting
<p>box:game_store chris$ cucumber features/user_sessions.feature<br />
Using the default profile...<br />
WARNING: Nokogiri was built against LibXML version 2.7.7, but has dynamically loaded 2.7.3<br />
..........</p>
<p>2 scenarios (2 passed)<br />
10 steps (10 passed)<br />
0m0.508s<br />
</p>
<h2>Debugging Webrat</h2><br />
<img src="http://squarism.com/wp-content/uploads/2010/12/cucumber_save_and_open-300x281.png" alt="" title="cucumber_save_and_open" width="300" height="281" class="alignright size-medium wp-image-797" />Next, the "seeing what webrat sees" problem.  The invalid login error was based on detecting text.  In my test app, when you're signed in you see the Logout link.  When you're signed out, you see the Login link.  Webrat was telling me that it couldn't sign in because Logout never appeared.  I had to figure out if it was lying because the app in my dev environment was working fine.  So I needed to see what webrat was seeing when launched from cucumber.
<p>I had hunted down a function called save_and_open_page but it never worked for me.  It's supposed to take a snapshot of the webrat client and open the web page in your browser so you can see what it sees.  It's like debugging with puts.  So if you're stuck on a step, just save_and_open_page and investigate.  Well unfortunately, I had left that option for dead a while ago because it wasn't working.  I had missed a key step:</p>
<p>Install the launchy gem.<br />
<code>gem install launchy</code></p>
<p>Now your default browser should launch with a simple snapshop of the page.  It's just a local file so you won't be able to click on links back to your app (unless you have some awesome hardcoded urls everywhere that would take you back from anywhere).  The idea here is to just look at what the client is seeing on a basic level.  I was getting an invalid login error message so I was looking any evidence related to logins.  You can see in the screenshot to the right that I have a Login link available.  In my app, that means I'm not logged in.  I put the save_and_open_page in the logout feature step of cucumber so this is a good thing.</p>
<p>Ok, so at this point my save_and_open_page was launching two pages.  What?  One was correct but the other one was incorrect.  That is to say, one page was giving me an invalid login and the other one was signing in fine.  So what is going on?</p>
<h2>Factorygirl</h2><br />
A key to my problem was how I was using factorygirl to create mock users and misunderstanding a convention.  First, here is the non-working features/step_definitions/user_session_steps.rb file:
<pre lang="ruby" line="0">require "authlogic/test_case"<br />
require "factory_girl"
<p>Factory.find_definitions</p>
<p>include Authlogic::TestCase</p>
<p>def user<br />
  @user ||= Factory :user<br />
end</p>
<p>def login<br />
  user<br />
  visit path_to("the homepage")<br />
  click_link "Log in"<br />
  fill_in "user_session_login", :with =&gt; "john"<br />
  fill_in "user_session_password", :with =&gt; "funkypass"<br />
  click_button "Login"<br />
end</p>
<p>def logout<br />
  click_link "Logout"<br />
  #save_and_open_page<br />
  visit path_to("the homepage")<br />
end</p>
<p>Given /^I am a registered user$/ do<br />
  user<br />
end</p>
<p>When /^I login$/ do<br />
  login<br />
end</p>
<p>Given /^I am logged in$/ do<br />
  login<br />
  visit path_to("the homepage")<br />
end</p>
<p>When /^I logout$/ do<br />
  logout<br />
end</p>
<p>The login method is all about clicking the Log in link and filling in the username and password boxes.  Now before you say, "what is john and funkypass?".  I tried many different variations of passwords.  I tried my passwords out of my dev db, obviously this won't work.  I tried foo1/foobar which actually led to my one working and one not case.</p>
<p>So here's what went wrong.  My feature file defines two scenarios for one feature, logging in and logging out:</p>
<pre lang="ruby" line="0">Feature: User Sessions
<p>  So that I can blah, blah, blah<br />
  As a registered user<br />
  I want to log in and log out</p>
<p>  Scenario: log in<br />
    Given I am a registered user<br />
    And I am on the homepage<br />
    When I login<br />
    Then I should see "Login successful!"<br />
    And I should see "Cart"</p>
<p>  Scenario: log out<br />
    Given I am logged in<br />
    And I am on the homepage<br />
    When I logout<br />
    Then I should see "Register"<br />
    And I should see "Log In"<br />
</p>
<p>The "When I login" step fires the login method.  But so does the "Given I am logged in" step.  So there are my two save_and_open_page hits, the reason I see two pages open when debugging.  But why would one work and the other one wouldn't?  I'm not changing anything.</p>
<p>The problem is factorygirl was creating a second user called foo2 for the <em>log out</em> scenario but rolling back the foo1 user that was created for the <em>log in</em> sceneario.  I didn't realize this when I hardcoded <code>fill_in "user_session_login", :with =&gt; "foo1"</code> during integration.  So in the log out scenario, foo1 would log in but only foo2 would exist in the DB.</p>
<p>So I changed the login method to look like this:</p>
<pre lang="ruby" line="0">def login<br />
  @user ||= Factory :user<br />
  visit path_to("the homepage")
<p>  click_link "Log in"</p>
<p>  fill_in "user_session_login", :with =&gt; @user.login<br />
  fill_in "user_session_password", :with =&gt; @user.password</p>
<p>  click_button "Login"<br />
  #save_and_open_page<br />
end<br />
</p>
<p>I really wanted to create a user once (what the ||= is trying to do) but I couldn't figure out how to properly use instance variables in a test step.  So I'll just do it this way for now.  Notice that I'm using the fields on @user so it'll always work.</p>
<h2>LibXML warning with Nokogiri</h2><br />
You may have noticed that I was receiving an warning here:<br />
<code>WARNING: Nokogiri was built against LibXML version 2.7.7, but has dynamically loaded 2.7.3</code><br />
I'm on OSX and I'm not sure what OSX is using but xml2-config --version shows 2.7.3.  So I'm pretty sure that it's using the shipped OS version.  Ok, no problem.  I'm running homebrew (a macports/fink replacement).  I'll just install 2.7.7:<br />
<code><br />
$ brew search xml<br />
  blahtexml	  libwbxml	    xml-tooling-c     xmlrpc-c		xmltoman<br />
  gccxml		  libxml2	    xml2rfc	      xmlstarlet<br />
  html-xml-utils	  xml-security-c    xmlformat	      xmlto<br />
$ brew install libxml2<br />
==&gt; Downloading ftp://xmlsoft.org/libxml2/libxml2-2.7.7.tar.gz<br />
######################################################################## 100.0%<br />
==&gt; ./configure --disable-dependency-tracking --prefix=/usr/local/Cellar/libxml2/2.7.7<br />
==&gt; make<br />
==&gt; make install<br />
==&gt; Caveats<br />
...<br />
$ brew info libxml2<br />
libxml2 2.7.7<br />
http://xmlsoft.org<br />
/usr/local/Cellar/libxml2/2.7.7 (293 files, 12M)<br />
http://github.com/mxcl/homebrew/commits/master/Library/Formula/libxml2.rb<br />
</code>
<p>Ok so it installed correctly.  Now we need to reinstall nokogiri using the 2.7.7 libs.<br />
<code><br />
gem install nokogiri -- --with-xml2-lib=/usr/local/Cellar/libxml2/2.7.7/lib --with-xml2-include=/usr/local/Cellar/libxml2/2.7.7/include<br />
</code></p>
<p>Now when we run cucumber, we won't get the error.  But here's the problem.  Brew provides a way to link to the brew version of libxml2 by default with the `brew link libxml2` command but issues a warning about doing this.  The problem with using a path like /usr/local/Cellar/libxml2/2.7.7/lib is eventually brew will update it to 2.7.8 or something and it's hard to say what the consequences will be.  Most likely, some binary will fail with lib errors.</p>
<h2>Wrapping up</h2><br />
Another note is that I was futzing with all of this in a git branch called "tdd", a branch I used to integrate cucumber/rspec and anything else related to testing.  I read some advice somewhere that a good practice is to branch a new feature and then roll it back into master when it's done.
<p>So I was already in the "tdd" branch had already committed everything.  It was time to merge the branches and get rid of the tdd branch:<br />
<code># switch back to master<br />
git checkout master<br />
# merge tdd into master<br />
git merge tdd<br />
# run the tests again for sanity<br />
cucumber features/user_sessions.feature<br />
# ok, passed, we don't need the tdd branch anymore<br />
git branch -d tdd<br />
# view branches<br />
git branch<br />
* master<br />
</code></p>
<p>After the merge, my code is up to date in the master branch and I can create a new branch called "rails3", for example, if I want to play with upgrading the app to rails 3.  Or I could create a branch called refactor if I was going to majorly overhaul code.</p>
</pre></pre></pre></code></p>

  </article>

</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">Squarism</h2>

    <div class="footer-col-1 column">
      <ul>
        <li>Squarism</li>
        <li><a href="mailto:squarism@gmail.com">squarism@gmail.com</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/squarism">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username">squarism</span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/squarism">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username">squarism</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">A tech blog about ruby, code, mongodb, golang and other stuff.</p>
    </div>

  </div>

</footer>


    </body>
</html>
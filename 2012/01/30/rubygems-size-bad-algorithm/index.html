<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Rubygems Size, Bad Algorithms and a Bad Data Structure</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="A tech blog about ruby, code, mongodb, golang and other stuff.">
    <link rel="canonical" href="http://squarism.com//2012/01/30/rubygems-size-bad-algorithm/">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/">Squarism</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          <a class="page-link" href="/about/">About</a>
        
          
        
          
        
          <a class="page-link" href="/about/index.html">About</a>
        
          <a class="page-link" href="/questions/index.html">Questions I Have</a>
        
          <a class="page-link" href="/tatris/index.html">Tatris - A Tetris Clone</a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Rubygems Size, Bad Algorithms and a Bad Data Structure</h1>
    <p class="meta">Jan 30, 2012 â€¢ Posted by: chris</p>
  </header>

  <article class="post-content">
  <p><img src="/uploads/2012/01/pixel_disk.png" alt="" title="pixel_disk" width="157" height="150" class="alignright size-full wp-image-1513" /><br />
I mirrored ruby gems just to see how big it would be.  I used the  rubygems-mirror gem.  It's pretty simple.  Just cd into a directory with a lot of space (ie: /opt/gems or something) and type `gem mirror`. </p>
<p>After a massive initial load of 155k gems, the size was about 45GB (currently, it grows pretty quick per week).  The rubygem and gem mirror command is smart enough to just download just the deltas when you run it again:</p>
<p><code><br />
$ gem mirror<br />
Fetching: http://rubygems.org/specs.4.8.gz<br />
Total gems: 170843<br />
Fetching 16176 gems<br />
................................................................<br />
</code></p>
<p>Then I <a href="http://twitter.com/#!/squarism/status/162574507817697280">wanted to know</a> the size of all the latest gems only.  If I had to do a lazy sneakernet, this might be one method of grabbing a whole bunch of dependencies (of course this would never work).  Regardless of that, I still wanted to know what percentage of ruby gems space is old versions.</p>
<p>So I wrote a ruby program to find all the latest versions of the gem files and total up their size.  I was not very happy about my experiments with #sort and #sort_by.  The biggest problem is that it took <strong>64 HOURS</strong> to run.  I knew it had lots of problems but I didn't want to kill it.  I wanted to see how bad it really ran.</p>
<p>I'm not going to post the actual code.  You can see the old version at this <a href="https://github.com/squarism/sandbox/commit/7208efed6eba5ea588e4c76e8f34626feac003d2">git commit url</a>.  The basic gist of the crappy algorithm was something like this:</p>
<pre>
Find all the files in the gem mirror off the filesystem.<br />
Get the basename of the file name (ie: strip the path).  /tmp/foo-0.1.gem -&gt; foo-0.1.gem<br />
Go through all the basenames (gem names) find the gem family.<br />
</pre>
<p>&lt;/p&gt;</p>
<p>Here's the problem.  I had a massive list of 170k gems and then I'm trying to do a find_all right here to sort the gems into gem families.  For example: there might be foo-0.1.gem, foo-0.2.gem and foo-async-0.1.gem.  In this example, there are two gem families out of the three gems.  Foo-async and foo are two different gems with their own versions.  Later on, I would:</p>
<pre>
Do a version compare.<br />
Push the latest version name to an array.<br />
Delete the gem family name from the gem_names array.<br />
</pre>
<p>&lt;/p&gt;</p>
<p>Sounded good on paper.  And then it took 65 hours to run (227305.19 seconds) and CPU was absolutely pegged the entire time.  This algorithm was easy to come up with in IRB using a small test data set but scaling up in the real use case completely sucked.  So I pushed it to github for versioning and rewrote the loop.</p>
<p>The <a href="https://github.com/squarism/sandbox/blob/master/latest_gem_sizes.rb">latest version</a> runs in 8.5 seconds and spits out a total size of all the latest ruby gems at 6.5GB.  Of course, this information is useless since it's not going to check compatibility or anything.  I was just curious to know how much space is back versions.</p>
<p>The real key to the new version is the fact that I'm using a proper "grouped" data structure (Hash) instead of a massive flat Array.  This allows the regexes and other operations to work on a smaller data set.  The compound nature of the previous inefficiency is pretty amazing (hours to seconds).</p>
<p><img src="/uploads/2012/01/gems_algorithm_1.png" alt="" title="gems_algorithm_1" width="650" height="375" class="aligncenter size-full wp-image-1520" /></p>
<p><img src="/uploads/2012/01/gems_algorithm_2.png" alt="" title="gems_algorithm_2" width="650" height="375" class="aligncenter size-full wp-image-1521" /></p>
<p><img src="/uploads/2012/01/gems_algorithm_3.png" alt="" title="gems_algorithm_3" width="650" height="375" class="aligncenter size-full wp-image-1522" /></p>
<p>So hopefully you see above that a huge array of a File glob is flat and makes regex's or grouping operations very time consuming.  Ruby's magic group_by method sorts and groups the data structure once and then it's much easier to regex out versions and do other things.</p>
<p>See below for the code inline or <a href="https://github.com/squarism/sandbox/blob/master/latest_gem_sizes.rb">take a look at the github repo</a>.</p>
<pre lang="ruby">
# refactored the 63 hour version to a much better 8.5 second version
<p>require 'action_view'<br />
include ActionView::Helpers</p>
<p># change to location of rubygems mirror<br />
GEM_DIR = "/opt/rubygems/gems"</p>
<p>gems = Dir.glob("#{GEM_DIR}/**/*.gem"); 1<br />
gems = gems.collect {|g| g.split("/").last}; </p>
<p>class Version<br />
  include Comparable<br />
  attr_reader :major, :feature_group, :feature, :bugfix, :version_string</p>
<p>  def initialize(version="")<br />
    @version_string = version<br />
    @major = "0"; @feature_group = "0"; @feature = "0"; @bugfix = "0"</p>
<p>    v = version.split(".")<br />
    # puts v.join("|")</p>
<p>    if v[0]; @major = v[0]; else; raise "Major number blank."; end<br />
    if v[1]; @feature_group = v[1]; end<br />
    if v[2]; @feature = v[2]; end<br />
    if v[3]; @bugfix = v[3]; end<br />
  end</p>
<p>  # strangely enough .to_i works even for<br />
  # &gt;&gt; "6-mswin32".to_i<br />
  # =&gt; 6<br />
  def &lt;=&gt;(other)<br />
    return @major &lt;=&gt; other.major if ((@major.to_i &lt;=&gt; other.major.to_i) != 0)<br />
    return @feature_group &lt;=&gt; other.feature_group if ((@feature_group.to_i &lt;=&gt; other.feature_group.to_i) != 0)<br />
    return @feature &lt;=&gt; other.feature if ((@feature.to_i &lt;=&gt; other.feature.to_i) != 0)<br />
    return @bugfix &lt;=&gt; other.bugfix if ((@bugfix.to_i &lt;=&gt; other.bugfix.to_i) != 0)<br />
    # we probably have two things equal here<br />
    return -1<br />
    puts "FALLING THROUGH in &lt;=&gt;, not good"<br />
  end</p>
<p>  def self.sort<br />
    self.sort!{|a,b| a &lt;=&gt; b}<br />
  end</p>
<p>  def to_s<br />
    @version_string<br />
  end<br />
end</p>
<p># temporary benchmarking<br />
RubyProf.start</p>
<p>group_r = Regexp.new(/(.*)-(\d+\.\d+.*)\.gem$/)<br />
gems_grouped = gems.group_by {|g| g.scan(group_r).flatten[0] }<br />
# =&gt; {"firewool"=&gt;["firewool-0.1.0.gem", "firewool-0.1.1.gem"}], ... }</p>
<p>latest_gems = []</p>
<p>gems_grouped.each do |g|<br />
  versions = g[1].collect {|ver| ver.scan(group_r).flatten[1] }<br />
  # =&gt; ["0.1.0", "0.1.1", "0.1.2"]</p>
<p>  begin<br />
    latest = versions.collect {|v| Version.new(v)}.sort.reverse.first<br />
    # =&gt; "0.1.2"<br />
  rescue ArgumentError<br />
    puts g<br />
  rescue NoMethodError<br />
    # somebody's got some crazy gem naming conventions<br />
    # for example: chill-1.gem<br />
    gems_grouped.delete g<br />
  end</p>
<p>  latest_gems &lt;&lt; "#{g[0]}-#{latest}.gem"<br />
end</p>
<p>total = 0<br />
latest_gems.each do |gem|<br />
  begin<br />
    total = total + File.size("#{GEM_DIR}/#{gem}")<br />
  rescue Errno::ENOENT =&gt; e<br />
    puts "WTF no #{gem}"<br />
  end</p>
<p>end</p>
<p>puts "Total size of newest gems in #{GEM_DIR} is #{number_to_human_size(total)}"<br />
</p>
<p>Algorithm win.  Rubygem mirror size curiosity complete.  6.5GB is current gems out of 45GB (right now).</p>
</pre>

  </article>

</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">Squarism</h2>

    <div class="footer-col-1 column">
      <ul>
        <li>Squarism</li>
        <li><a href="mailto:squarism@gmail.com">squarism@gmail.com</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/squarism">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username">squarism</span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/squarism">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username">squarism</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">A tech blog about ruby, code, mongodb, golang and other stuff.</p>
    </div>

  </div>

</footer>


    </body>
</html>
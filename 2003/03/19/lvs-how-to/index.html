<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>LVS HOW-TO</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="A tech blog about ruby, code, mongodb, golang and other stuff.">
    <link rel="canonical" href="http://squarism.com//2003/03/19/lvs-how-to/">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/">Squarism</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          <a class="page-link" href="/about/">About</a>
        
          
        
          
        
          <a class="page-link" href="/about/index.html">About</a>
        
          <a class="page-link" href="/questions/index.html">Questions I Have</a>
        
          <a class="page-link" href="/tatris/index.html">Tatris - A Tetris Clone</a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>LVS HOW-TO</h1>
    <p class="meta">Mar 19, 2003 â€¢ Posted by: chris</p>
  </header>

  <article class="post-content">
  <p>
This is a short guide on how to build a Linux Virtual Server cluster.  What you'll end up with is a cluster that is good for load balancing web pages and any other simple services.<br />
</p>
<p>&lt;/p&gt;</p>
<p><a id="more"></a><a id="more-16"></a></p>
<h2>Introduction</h2>
<p>&lt;/p&gt;</p>
<p><font color="red">This is not a one-size-fits-all HOWTO.</font>  This is how I did it, and if you want the same result, you can follow these steps.  I use specific software versions, so be sure to use the same ... unless of course you are an expert (then you could send me some tips and suggestions- they are no doubt needed).  No warranty, batteries not included, your mileage may vary ...  :)<br />
</p>
<p>&lt;/p&gt;</p>
<p>
<b>What, why?</b><br /><br />
I wanted to build a cluster of linux boxes to provide faster and redundant Apache service.  I realized that a quick way to add PCs was needed.  My goal was to bring in a PC and with minimal typing and effort have another node in my cluster.</p>
<p>First, I needed to get kickstart working.  Then I need to build a cluster.  Then I can customize my kickstart to make building a cluster node easier.  At the end of the kickstart, you are given an opportunity to kick off a script of your design.<br />
</p>
<p>&lt;/p&gt;</p>
<p>
<b>What is kickstart?</b><br /><br />
If you are familiar with Micro$oft's unattended installs on NT4 and 2000, then this is the Linux equivalent.  A kickstart config answers all the questions that the RedHat installer asks you.  You stick a boot disk in, the Linux kernel boots, you give the kernel a parameter of where to find the kickstart config file and hopefully that's it.<br />
</p>
<p>&lt;/p&gt;</p>
<p>
<b>What do I need?</b></p>
<ul>
<li>Three computers that you don't care about</li>
<li>RedHat 7.2 - cdroms or your own repository</li>
<li>a switch or hub</li>
<li>some way to see all three systems (KVM switch or three monitors)</li>
<li>a few floppy disks</li><br />
</ul>
<p>&lt;/p&gt;</p>
<p><b>What will I get?</b></p>
<ul>
<li>A high-availability system that can survive many disasters - <i>One real-server goes down, the others still run (there are other methods not covered here to create redundant directors)</i></li>
<li>You'll get a cluster-like group of Linux machines - <i>Imagine moving to a new office location, or hosting center.  You can easily move computers out one at a time while keeping the service alive</i></li>
<li>Making use of old machines - <i>although fast machines are nice, using lots of cheap slow machines can still make for a nice LVS</i></li>
<li>Don't have to buy expensive proprietary solution</li><br />
</ul>
<p>&lt;/p&gt;</p>
<h3>Physical Layout</h3>
<p>&lt;/p&gt;</p>
<pre>
           ____<br />
           |  |<br />
           |  | director &amp;<br />
           |  | NAT Router<br />
           ----
<p>     |-------+-------|</p>
<p>  RealServer1    RealServer2<br />
(real servers - machines that do the real work)<br />
</p>
<h3>Network Layout</h3>
<pre>
 Director<br />
 eth0: 192.168.X.X (from corporate LAN DHCP - to Internet)<br />
 eth1: 172.16.0.1 (DHCP listening on this interface, NAT)
<p> RS1<br />
 eth0: 172.16.0.21 (DHCP reservation)</p>
<p> RS2<br />
 eth0: 172.16.0.22 (DHCP reservation)<br />
</p>
<p><h2>The Director Setup</h2><br />
Install 7.2 on the director.  Install <b>everything</b>, it's easy and it's simple (yes, lazy).</p>
<p>
<b>DHCP</b><br /><br />
First, I got the physical addresses for the interfaces of rs1 &amp; rs2 by booting off a linux rescue disk (<a href="http://lbt.linuxcare.com/downloads/lxcr-lbt-2_0.iso">linuxcare.com has an iso</a>)that got me to a shell where I could issue the ifconfig command.  I wrote them down (it's listed under HWaddr), then I setup DHCP on the Director:</p>
<p>
In /etc/dhcpd.conf:</p>
<pre>subnet 172.16.0.0 netmask 255.255.0.0 {<br />
        range 172.16.0.10 172.16.0.254;<br />
        option subnet-mask 255.255.0.0;<br />
        option broadcast-address 172.16.0.255;<br />
        option routers 172.16.0.1;<br />
        option domain-name-servers 172.16.0.1;<br />
        option domain-name "domain.com";
<p>        host rs1.domain.com {<br />
                hardware ethernet 00:60:08:cf:bd:6d;<br />
                fixed-address 172.16.0.21;<br />
        }</p>
<p>        host rs2.domain.com {<br />
                hardware ethernet 00:a0:24:c5:e7:de;<br />
                fixed-address 172.16.0.22;<br />
        }<br />
}<br />
</p>
<p>I restarted DHCP:</p>
<pre>#/etc/rc.d/init.d/dhcpd restart</pre>
<p>
Now both boxes have reservations as well as a router address pointing to the internal interface of the Director which is acting as a NAT box.  Alternatively, I also read that I could make a kickstart config file that would be named "172.16.0.21-kickstart" for rs1 and if I didn't specify a file name, the kickstart install would grab that one.  I didn't do it that way, but an alternative.<br />
</p>
<p>
<b>NAT</b><br /><br />
Then I set up NAT routing for the real servers.  This keeps my little project off the company LAN while giving the boxes net access.<br />
</p>
<p>
IP-Masq rules are written into a file. Let's call it '/etc/rc.d/rc.masq'. The location of this file will be the directory '/etc/rc.d/', which contains all the scripts started at boot time. A very simple 'rc.masq' file may look like this (each rule on one line):<br />
</p>
<pre>
#!/bin/sh<br />
echo -n "Setting IP chains..."<br />
echo "1" &gt; /proc/sys/net/ipv4/ip_forward<br />
/sbin/ipchains -P forward DENY<br />
/sbin/ipchains -A forward -s 172.16.0.0/16 -d 172.16.0.0/16 -j ACCEPT<br />
/sbin/ipchains -A forward -s 172.16.0.0/16 -j MASQ<br />
/sbin/ipchains -A forward -p tcp -s 0.0.0.0/0 137:139 -j DENY<br />
/sbin/ipchains -A forward -p udp -s 0.0.0.0/0 137:139 -j DENY<br />
/sbin/modprobe ip_masq_ftp<br />
echo "1" &gt; /proc/sys/net/ipv4/ip_dynaddr<br />
echo "Ready to go."<br />
</pre>
<p>
Lines seven and eight were those who actually required some work to find out ;-). For some reason Windows clients issue requests via these ports from time to time, leading to involuntary dial-ups (if you're running dial-up). These two lines stop this annoying behavior.  Line nine loads the ftp module. Only load those modules you need! This is more secure and lighter on system resources.  Line ten enables masquerading for interfaces with dynamically assigned addresses (like most modem lines nowadays). If you have a static IP, you don't need it.  Now, there are just three more things to do: edit '/etc/sysconfig/network' and change</p>
<p><pre>FORWARD_IPV4=false to FORWARD_IPV4=true</pre></p>
<p>
Make the script executable</p>
<pre>chmod +x /etc/rc.d/rc.masq</pre><br />
Then add the 'rc.masq' script to the boot process. Open /etc/rc.d/rc.local and add this line:
<pre>if [ -x /etc/rc.d/rc.masq ]; then /etc/rc.d/rc.masq; fi</pre>
<p>
Finally, some security measures:</p>
<p>
Only 'root' should be allowed to execute 'ipchains':</p>
<pre>chmod 700 /sbin/ipchains </pre><br />
Only 'root' should be allowed to see, edit and execute the 'rc.masq' script:
<pre>chmod 700 /etc/rc.d/rc.masq </pre><br />
If you want to test your set up right now, run (as 'root')
<pre>/etc/rc.d/rc.masq</pre>
<p>
<b>HTTPD</b><br /><br />
Like I said, I had a horrible time with NFS as the install source.  Anyone is welcome to try, but it would error out during the install.  I figure 'http' is a lighter weight protocol anyway (though someone can correct me).  I made a dir /var/www/html/RH72 and did a
<pre>cp -rv /mnt/cdrom/RedHat /var/www/html/RH72</pre> with both disc1 and disc2.  So that takes care of our source directory, now we just need some kickstart configs and an easy way to update / distribute them to new booting nodes.<br />
</p>
<p>
<b>NFS</b><br /><br />
Make a directory called /kickstart.  This will hold all of the config files for specific clients.  You can use the following config for rs1:</p>
<pre>
#localized stuff<br />
lang en_US<br />
langsupport --default en_US<br />
timezone America/New_York<br />
keyboard us<br />
mouse generic3ps/2
<p>auth --enablemd5 --useshadow<br />
bootloader --location=mbr<br />
clearpart --all<br />
deviceprobe<br />
firewall --disabled</p>
<p># This is how you can do an NFS install, but I had problems<br />
#nfs --server 172.16.0.1 --dir /kickstart/redhat<br />
url --url http://172.16.0.1/RH72<br />
network --bootproto dhcp --device eth0 --hostname rs1</p>
<p>part swap --size 128<br />
part / --size 400 --grow --fstype ext3 --ondisk hda</p>
<p>rootpw --iscrypted Xa.ikIAyi3mTk<br />
skipx</p>
<p>%packages<br />
@ Network Managed Workstation<br />
@ Utilities<br />
@ Software Development<br />
@ Kernel Development<br />
@ Web Server<br />
</p>
<p>You can make the 'Xa.ikIAyi3mTk' string from the following perl one-liner (it doesn't have to be 'mypassword'):</p>
<pre>perl -e 'print crypt("mypassword", "Xa")."\n";'</pre><br />
So your root password isn't plainly viewable in a flat text file.  :)
<p>
Save the rs1 config as /kickstart/rs1.cfg.  Copy rs1.cfg to a new file 'rs2.cfg'.  Then change the hostname in rs2.cfg to rs2.  This way, you can easily manage your install scripts.</p>
<p>
<i>A full list of kickstart options is <a href="http://www.redhat.com/docs/manuals/linux/RHL-7.2-Manual/custom-guide/s1-kickstart2-options.html">here</a></i></p>
<p>
Edit /etc/exports to export /kickstart via NFS:</p>
<pre>
# kickstart shares<br />
/kickstart 172.16.0.0/16(ro,no_root_squash)<br />
</pre><br />
Export it:
<pre>
 exportfs -a<br />
</pre><br />
Make sure NFS and HTTPD is running:
<pre>
 /etc/rc.d/init.d/nfs status<br />
 /etc/rc.d/init.d/httpd status<br />
</pre><br />
And then we start the kickstart...
<h2>The Kickstart</h2><br />
<b>Make a bootdisk</b><br /><br />
Stick your RedHat 7.2 disc1 and a floppy into your Director.
<pre>
 mount /mnt/cdrom<br />
 mount /mnt/floppy<br />
 dd if=/mnt/cdrom/RedHat/images/bootnet.img of=/dev/fd0 bs=1440k<br />
 umount /mnt/floppy<br />
 eject<br />
</pre>
<p><b>Start the kickstart</b><br /><br />
Boot rs1 off the floppy.  At the linux boot prompt type:</p>
<pre>
linux ks=nfs:172.16.0.1:/kickstart/rs1.cfg<br />
</pre>
<p>
Do the same for rs2, but use rs2.cfg.  Hopefully, the install will go smoothly.  If you get a 'cannot find ks.cfg' error, then test your nfs server by trying to mount /kickstart on a machine that's on the 172.16.0.0 network.<br />
</p><br />
<br /><br />
<p><h2>The Cluster</h2><br />
Now that we have the real servers set up, the hard part starts.</p>
<p>
<b>Software</b></p>
<ul>
<li><a href="http://www.linuxvirtualserver.org/software/index.html">Linux Virtual Server</a></li>
<li><a href="ftp://ftp.kernel.org/pub/linux/kernel/v2.2">Linux Kernel 2.2.19</a></li><br />
</ul>
<p>
<b>Patching the Kernel Source</b><br />
Download the linux kernel to /usr/src (I had samba running, so I downloaded from IE to a samba share and then moved the tarball).  I found that RedHat had made a symlink of linux-2.4 -&gt; linux-2.4.2.  The linux-2.2.19.tar.gz tarball extracts to ./linux so it's ok to just do</p>
<pre>
 mv [where you downloaded linux-2.2.19.tar.gz] /usr/src<br />
 cd /usr/src<br />
 tar xvzf linux-2.2.19.tar.gz<br />
</pre><br />
in the /usr/src directory, it will extract to /usr/src/linux.  Also extract the ipvs patch:
<pre>
 mv [where you downloaded ipvs-1.0.8-2.2.19.tar.gz] /usr/src<br />
 tar xvzf ipvs-1.0.8-2.2.19.tar.gz<br />
</pre><br />
That should expand to /usr/src/ipvs-1.0.8-2.2.19.  Now patch the kernel source with (from README included with the ipvs patch):
<pre>
 cat ../ipvs-1.0.8-2.2.19/ipvs-1.0.9-2.2.19.patch | patch -p1<br />
</pre><br />
If you are running X, you might prefer
<pre>
 make xconfig<br />
</pre><br />
from within an xterm (or equivalent) window instead of the menuless text-mode
<pre>
 make menuconfig<br />
</pre>
<p>(from ipvs README)<br />
<p>Here's the kernel config<br />
<p><br />
<pre><br />
Kernel Compile Options:
<p>Code maturity level options ---<br />
        [*] Prompt for development and/or incomplete code/drivers<br />
Networking options ---<br />
        [*] Network firewalls<br />
        ....<br />
        [*] IP: firewalling<br />
        ....<br />
        [*] IP: masquerading<br />
        ....<br />
        [*] IP: masquerading virtual server support<br />
        [ ]   IP virtual server debugging<br />
        (12)  IP masquerading table size (the Nth power of 2)<br />
        <m>   IPVS: round-robin scheduling<br />
        <m>   IPVS: weighted round-robin scheduling<br />
        <m>   IPVS: least-connection scheduling<br />
        <m>   IPVS: weighted least-connection scheduling<br />
        <m>   IPVS: locality-based least-connection scheduling<br />
        <m>   IPVS: locality-based least-connection with replication scheduli<br />
        ....<br />
        [*] IP: aliasing support<br />
<br />
Before you save the kernel config, be sure to enable all the other features that you want.  Especially check that your<br />
network cards are supported and installed as loadable kernel modules (M).  You may want USB support as well.  Try to keep your kernel light while providing yourself enough functionality.  After you are done,<br />
save the kernel configuration and do
<pre>
 make dep; make clean; make bzImage; make modules; make install; make modules_install<br />
</pre><br />
<b>Get some coffee.</b>
<p>
When it's done, delete the old symbolic links, copy the new kernel system files and create new sym links like this:</p>
<pre>
 cd /boot<br />
 rm System.map -f<br />
 rm vmlinuz -f<br />
 rm kernel.h -f<br />
 cp /usr/src/linux/System.map System.map-2.2.19<br />
 cp /usr/src/linux/arch/i386/boot/bzImage vmlinuz-2.2.19<br />
 cp /usr/src/linux/include/linux/kernel.h kernel.h-2.2.19<br />
 ln -s System.map-2.2.19 System.map<br />
 ln -s vmlinuz-2.2.19 vmlinuz<br />
 ln -s kernel.h kernel.h-2.2.19<br />
</pre>
<p>
If you use lilo for you boot loader (7.2 can use grub too) Edit /etc/lilo.conf to look like this:</p>
<pre>
boot=/dev/hda<br />
map=/boot/map<br />
install=/boot/boot.b<br />
prompt<br />
timeout=50<br />
# VESA framebuffer console @ 800x600x32k<br />
vga=787<br />
# Normal VGA console<br />
#vga = normal<br />
message=/boot/message<br />
linear<br />
default=linux-2.2.19
<p>image=/boot/vmlinuz-2.4.2-2<br />
        label=linux-2.4.2-2<br />
        read-only<br />
        root=/dev/hdb1</p>
<p>image=/boot/vmlinuz-2.2.19<br />
        label=linux-2.2.19<br />
        read-only<br />
        root=/dev/hdb1<br />
<br />
Run:</p>
<pre>
 /sbin/lilo -v<br />
</pre><br />
If you use grub, then /etc/grub.conf should look like this:
<pre>
# grub.conf generated by anaconda<br />
#<br />
# Note that you do not have to rerun grub after making changes to this file<br />
# NOTICE:  You do not have a /boot partition.  This means that<br />
#          all kernel and initrd paths are relative to /, eg.<br />
#          root (hd0,0)<br />
#          kernel /boot/vmlinuz-version ro root=/dev/hda1<br />
#          initrd /boot/initrd-version.img<br />
#boot=/dev/hda<br />
default=1<br />
timeout=10<br />
splashimage=(hd0,0)/boot/grub/splash.xpm.gz<br />
title Red Hat Linux (2.4.7-10)<br />
        root (hd0,0)<br />
        kernel /boot/vmlinuz-2.4.7-10 ro root=/dev/hda1<br />
        initrd /boot/initrd-2.4.7-10.img<br />
title Red Hat Linux (2.2.19)<br />
        root (hd0,0)<br />
        kernel /boot/vmlinuz-2.2.19 ro root=/dev/hda1<br />
</pre>
<p>It should run without errors and then you are ready to reboot:</p>
<pre>
 /sbin/init 6<br />
</pre>
<p>
Get DNS Perl module<br />
http://www.fuhr.org/~mfuhr/perldns/<br />
perl Makefile.PL; make; make test; make install<br />
</p>
<p>
LVS configure script</p>
<pre>
#----------lvs_nat.conf------------------------------------<br />
LVSCONF_FORMAT=1.1<br />
LVS_TYPE=VS_NAT<br />
INITIAL_STATE=on<br />
CLEAR_IPVS_TABLES=yes<br />
#<br />
#VIP line format - device[:alias] IP netmask broadcast<br />
#To help avoid namespace collisions with other VIPs, I set alias=last number of VIP (here 110).<br />
VIP=eth1:50 lvs 255.255.255.255 lvs<br />
#<br />
#DIP line format - device[:alias] IP network netmask broadcast<br />
DIP=eth0:9 dip 192.168.155.12 255.255.252.0 192.168.152.255<br />
#<br />
#DIRECTOR_GW - packets with src_addr=VIP, dst_addr=0/0 are sent to DIRECTOR_GW<br />
#to be forwarded to the outside world.<br />
#The script will not neccesarily set up the DIRECTOR_GW as the director's default gw.<br />
DIRECTOR_GW=192.168.153.1<br />
#<br />
#SERVICE line format - proto port scheduler IP|name:port[,weight] [IP|name:port[,weight]]<br />
SERVICE=t httpd wlc rs1:http,3 rs2:http,1<br />
#<br />
SERVER_NET_DEVICE=eth0<br />
#VS-NAT real-servers do not have a VIP, i.e. there is no SERVER_VIP_DEVICE<br />
#SERVER_VIP_DEVICE=<br />
#SERVER_GW is not user configurable with VS-NAT. script sets SERVER_GW = DIP<br />
#SERVER_GW=<br />
#----------end lvs_nat.conf---------------------------------<br />
</pre><br />

<p>
Add /etc/hosts<br />
</p>
<p>
 ipvsadm -A -t 192.168.155.50:ssh -s wlc<br />
 ipvsadm -a -t 192.168.155.50:ssh -r rs1:ssh -m<br />
 ipvsadm -a -t 192.168.155.50:ssh -r rs2:ssh -m<br />
 ipvsadm -L<br />
</p>
<p>
I put the following in a directory called /opt/lvs_software:</p>
<pre>
[root@guestntdt public]# ls /opt/lvs_software/<br />
configure-lvs_0.9.2  ipvsadm              Net-DNS-0.12<br />
ipvs-1.0.8-2.2.19    linux-2.2.19.tar.gz<br />
</pre><br />
Then made the nfs export:
<pre>
/etc/exports:<br />
# kickstart shares<br />
/kickstart 172.16.0.0/16(ro,no_root_squash)<br />
# LVS stuff<br />
/opt/lvs_software 172.16.0.0/16(ro,no_root_squash)<br />
</pre><br />

<p>
Start nfs server:</p>
<pre>
 /etc/rc.d/init.d/nfs start<br />
</pre>
<p><h2>RS1 &amp; RS2 setup</h2><br />
 mkdir /mnt/nfs<br />
 mount dir1:/opt/lvs_software /mnt/nfs<br />
 cd /mnt/nfs<br />
 tar -xvzC /usr/src -f linux-2.2.19.tar.gz<br />
 cd /usr/src/linux<br />
 cat /mnt/nfs/ipvs-1.0.8-2.2.19/ipvs-1.0.8-2.2.19.patch | patch -p1<br />
 make menuconfig<br />
</p>
<p>
Follow the instructions as listed above for the director.  Be sure to set up your NIC correctly.  If you don't know what kind of NIC you have, do an `lspci`.<br />
Reboot after editing grub as listed above.  Be sure to watch the startup.  I got a few errors because of the different modules.<br />
The important things to watch are your partitions mounting and your NIC (eth0) coming up.<br />
</p>
<h3>Screen</h3>
<p>
I used the "screen" program to make my life easier.  I would SSH into the director using <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/">PuTTY</a> and then run screen so I wouldn't have to use the KVM switch.  I put the following in /root/.screenrc:</p>
<pre>
screen -t rs1 2 ssh rs1<br />
screen -t rs2 3 ssh rs2<br />
shelltitle '&gt; |bash'<br />
screen 1<br />
</pre><br />
Then I ran "screen" and it makes term1 the dir1 term, term2 the rs1 term and term3 the rs2 term.  You can switch with CTRL-A, [number].  You can add a terminal with CTRL-A, [minus], CTRL-A, CTRL-C.  Screen is a great but somewhat confusing program.  Take a look at the shortcut keys in "man screen".
<h3>More RS1 Setup</h3><br />
Mount the nfs drive again on each of the realservers (rs1, rs2)
<pre>
mount dir1:/opt/lvs_software /mnt/nfs<br />
cd /mnt/nfs<br />
</pre><br />
There are premade configs files there but I didn't find them useful.  Instead I used this modified one:
<pre>
#----------lvs_nat.conf------------------------------------<br />
LVSCONF_FORMAT=1.1<br />
LVS_TYPE=VS_NAT<br />
INITIAL_STATE=on<br />
CLEAR_IPVS_TABLES=yes<br />
VIP=eth0:50 192.168.155.50 255.255.255.255 192.168.155.255<br />
DIP=eth0 172.16.0.1 172.16.0.0 255.255.0.0 172.16.255.255<br />
DIRECTOR_GW=192.168.153.1<br />
SERVER_NET_DEVICE=eth0<br />
SERVICE=t http wlc rs1:http,3 rs2:http,1<br />
#----------end lvs_nat.conf---------------------------------<br />
</pre><br />
Then run ./configure lvs_nat.conf.  This will produce a file call rc.lvs_nat.  This script can detect if you are running it on either the director or the realservers.
<p>
Run the script on the director.  "ipvsadm -L" should show you:</p>
<pre>
Prot LocalAddress:Port Scheduler Flags<br />
  -&gt; RemoteAddress:Port             Forward Weight ActiveConn InActConn<br />
TCP  192.168.155.50:http wlc<br />
  -&gt; rs2:http                       Masq    1      0          0<br />
  -&gt; rs1:http                       Masq    3      0          0<br />
</pre><br />
And ifconfig should show you the aliased eth0 [note the same hw address in the eth0 devices]:
<pre>
[root@dir1 configure-lvs_0.9.2]# ifconfig<br />
eth0      Link encap:Ethernet  HWaddr 00:10:4B:2E:C4:36<br />
          inet addr:192.168.155.12  Bcast:192.168.155.255  Mask:255.255.252.0<br />
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1<br />
          RX packets:205476 errors:0 dropped:0 overruns:0 frame:0<br />
          TX packets:28906 errors:0 dropped:0 overruns:0 carrier:0<br />
          collisions:0 txqueuelen:100<br />
          Interrupt:10 Base address:0xfcc0
<p>eth0:50   Link encap:Ethernet  HWaddr 00:10:4B:2E:C4:36<br />
          inet addr:192.168.155.50  Bcast:192.168.155.255  Mask:255.255.255.255<br />
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1<br />
          Interrupt:10 Base address:0xfcc0</p>
<p>eth1      Link encap:Ethernet  HWaddr 00:01:03:E9:6C:FF<br />
          inet addr:172.16.0.1  Bcast:172.16.255.255  Mask:255.255.0.0<br />
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1<br />
          RX packets:31574 errors:0 dropped:0 overruns:0 frame:0<br />
          TX packets:46073 errors:0 dropped:0 overruns:0 carrier:0<br />
          collisions:1814 txqueuelen:100<br />
          Interrupt:3 Base address:0xfc00</p>
<p>lo        Link encap:Local Loopback<br />
          inet addr:127.0.0.1  Mask:255.0.0.0<br />
          UP LOOPBACK RUNNING  MTU:3924  Metric:1<br />
          RX packets:171 errors:0 dropped:0 overruns:0 frame:0<br />
          TX packets:171 errors:0 dropped:0 overruns:0 carrier:0<br />
          collisions:0 txqueuelen:0<br />
</p>
<p>You can always up/down the VIP with:</p>
<pre>ifconfig eth0:0 192.168.155.50 netmask 255.255.252.0 broadcast 192.168.155.50 up</pre>
<h3>Login easier with no passwords</h3>
<pre>
ssh-keygen -t rsa<br />
# [enter for blank password]<br />
scp ~/.ssh/id_rsa.pub rs1:/root/.ssh/authorized_keys2<br />
scp ~/.ssh/id_rsa.pub rs2:/root/.ssh/authorized_keys2<br />
ssh rs1<br />
ssh rs2<br />
</pre>
<p><br /><br /></p>
<p><h1>Other Resources</h1><br />
<a href="http://www.linuxnewbie.org/nhf/intel/distros/mandrake/mdk_kernel_upgrade.html">Linuxnewbie.org kernel upgrade guide</a><br />
<a href="http://www.linuxdoc.org/HOWTO/KickStart-HOWTO.html">linuxdoc</a> - KickStart HOWTO in a nice, one-page format<br /><br />
<a href="http://www.redhat.com/support/resources/howto/piranha/example-layout.html">LVS Cluster example</a><br /><br />
<a href="http://gen100.imb-jena.de/cluster/software/">Larger clustering</a><br /><br />
<a href="http://www.reptechnic.com.au/kickstart.html">How to make a kickstart bootdisk</a><br /><br />
<a href="http://www.linux-mag.com/2001-08/traffic_01.html">Linux Magazine LVS How-to</a><br /></p>
</pre></pre></m></m></m></m></m></m></p></pre></p></p></p></pre></pre></pre></pre>

  </article>

</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">Squarism</h2>

    <div class="footer-col-1 column">
      <ul>
        <li>Squarism</li>
        <li><a href="mailto:squarism@gmail.com">squarism@gmail.com</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/squarism">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username">squarism</span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/squarism">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username">squarism</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">A tech blog about ruby, code, mongodb, golang and other stuff.</p>
    </div>

  </div>

</footer>


    </body>
</html>
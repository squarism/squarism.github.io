<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Pivot Table in Ruby</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="A tech blog about ruby, code, mongodb, golang and other stuff.">
    <link rel="canonical" href="http://squarism.com//2011/05/02/pivot-table-in-ruby/">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/">Squarism</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          <a class="page-link" href="/about/">About</a>
        
          
        
          
        
          <a class="page-link" href="/about/index.html">About</a>
        
          <a class="page-link" href="/questions/index.html">Questions I Have</a>
        
          <a class="page-link" href="/tatris/index.html">Tatris - A Tetris Clone</a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Pivot Table in Ruby</h1>
    <p class="meta">May 2, 2011 • Posted by: chris</p>
  </header>

  <article class="post-content">
  <p>Sometimes you need to transpose data from columns to rows or vice-versa.  In the SQL world, this is called a pivot table.  Usually this happens when you're coming from a key-value store and want to turn it into something more structured but it can also happen in poorly designed or legacy databases.  The idea is pretty simple, pivot the data from rows into columns.  For example, here's a listing of CDs:</p>
<pre>
-------------------------------------<br />
DJ Shadow       |  electronica<br />
DJ Shadow       |  1996<br />
DJ Shadow       |  Endtroducing<br />
The Avalanches  |  Since I Left You<br />
The Avalanches  |  2000<br />
The Avalanches  |  electronica<br />
-------------------------------------<br />
</pre>
<p>&lt;/p&gt;</p>
<p>There are really only two CDs here but the data is presented to us as artist:attribute pairs.  We want the data to look like this:</p>
<pre>
Artist         | Genre       | Album            | Year<br />
------------------------------------------------------<br />
DJ Shadow      | electronica | Entroducing      | 1996<br />
The Avalanches | electronica | Since I Left You | 2000<br />
</pre>
<p><br />
<a id="more"></a><a id="more-1238"></a>&lt;/p&gt;</p>
<h3>First Example</h3>
<p><br />
First of all, the starting data (the first key value pair listing) doesn’t have the data labeled so this creates a problem.  We have to assume that the key is the artist and label that accordingly.  After that, the attributes are not labeled so we’re not going to be able to create the column headings without more information.  So I’ll show two examples here, one with unlabeled data and the second with proper labeling.&lt;/p&gt;</p>
<p>The first example makes an assumption that the order of the attributes is significant.  IE: album, year, genre.  We have to make this assumption for the pretty table printing.  If this is not the case, the logical impact is minimal and you can ignore this.</p>
<pre lang="ruby"># FIRST EXAMPLE where data is associated by unique strings but<br />
# not explicit with keys or labels, for example :year =&gt; 1996 is not explicit<br />
unpivoted_data = [<br />
  { "DJ Shadow" =&gt; "Endtroducing" },<br />
  { "DJ Shadow" =&gt; "1996" },<br />
  { "DJ Shadow" =&gt; "electronica" },<br />
  { "The Avalanches" =&gt; "Since I Left You" },<br />
  { "The Avalanches" =&gt; "2000" },<br />
  { "The Avalanches" =&gt; "electronica" }<br />
]
<p># make new array<br />
pivoted = Hash.new</p>
<p>unpivoted_data.each do |d|<br />
  # key of each hash element should be only one element long<br />
  key = d.keys.first.to_sym</p>
<p>  if pivoted[key] == nil<br />
    pivoted[key] = Array.new<br />
  end</p>
<p>  pivoted[key] &lt;&lt; d.values.first</p>
<p>end</p>
<p># The variable pivoted at this point looks like this:<br />
# {:"DJ Shadow"=&gt;["electronica", "1996", "Endtroducing"],<br />
# :"The Avalanches"=&gt;["Since I Left You", "2000", "electronica"]}</p>
<p># pretty table print<br />
# first pass, determine biggest columns and store</p>
<p># biggest size of key<br />
max_lengths = []<br />
pivoted.keys.each do |key|<br />
  if max_lengths[0].nil? || key.length &gt; max_lengths[0]<br />
    max_lengths[0] = key.length<br />
  end<br />
end</p>
<p># biggest size of values array inside key<br />
pivoted.keys.each do |element|<br />
  # we already have max_lengths[0] from key<br />
  i = 1<br />
  pivoted[element].each do |subelement|<br />
   if max_lengths[i].nil? || subelement.length &gt; max_lengths[i]<br />
     max_lengths[i] = subelement.length<br />
   end<br />
   i += 1<br />
  end<br />
end</p>
<p>puts "Pivoted Unlabeled:"<br />
line_size = max_lengths.inject{|sum,x| sum + x } + max_lengths.length * 3 - 1<br />
puts "-" * line_size</p>
<p># pad columns with spaces and bars from max_lengths<br />
pivoted.keys.each do |key|<br />
  string = key.to_s.ljust(max_lengths[0])<br />
  string &lt;&lt; " | "</p>
<p>  i = 1<br />
  pivoted[key].each do |attribute|<br />
    string &lt;&lt; attribute.ljust(max_lengths[i]) &lt;&lt; " | "<br />
    i += 1<br />
  end</p>
<p>  # string = key.to_s &lt;&lt; " | " &lt;&lt; pivoted[key].join(" | ")<br />
  puts string<br />
end</p>
<p># spacer<br />
puts ""<br />
</p>
<p>This code will output:</p>
<pre>
Pivoted Unlabeled:<br />
--------------------------------------------------------<br />
DJ Shadow      | Endtroducing     | 1996 | electronica |<br />
The Avalanches | Since I Left You | 2000 | electronica |<br />
</pre>
<p>Nice bit of pretty printing there.  Completely unnecessary but gives a nice feel of a pivot table even if we are not working with a database or activerecord.</p>
<h3>Second Example</h3><br />
The second example of pivoting data involves a data structured that is related by a primary key and each subelement has a field with a name.  This could be a 2D data structure from a database or anything that is highly structured and organized.  The ID field in this case is barely significant.  It just acts as a label, in this example it is the ID of the album as pulled from freedb.org.
<p>This code takes a different approach of creating a hash of hashes to pivot the data.  After that, it creates a 2D array for tablular printing.  The maximum column size is computed for pretty printing.</p>
<pre lang="ruby"># SECOND EXAMPLE where data is labeled.  This is easier / cleaner.<br />
# IDs represent CDs pulled from freedb.org<br />
unpivoted_data = [<br />
  { :freedb =&gt; "a70eb30d", :artist =&gt; "DJ Shadow" },<br />
  { :freedb =&gt; "a70eb30d", :genre =&gt; "electronica" },<br />
  { :freedb =&gt; "a70eb30d", :year =&gt; 1996 },<br />
  { :freedb =&gt; "a70eb30d", :album =&gt; "Endtroducing" },<br />
  { :freedb =&gt; "090e6012", :artist =&gt; "The Avalanches" },<br />
  { :freedb =&gt; "090e6012", :genre =&gt; "electronica" },<br />
  { :freedb =&gt; "090e6012", :year =&gt; 2000 },<br />
  { :freedb =&gt; "090e6012", :album =&gt; "Since I Left You" }<br />
]
<p># hash of hashes<br />
pivoted = Hash.new</p>
<p>unpivoted_data.each do |d|<br />
  # store the unique ID so we can remember if we've seen the CD before<br />
  id = d.values.first.to_sym</p>
<p>  # attribute to merge<br />
  attribute_key = d.keys[1]<br />
  attribute = d[attribute_key]</p>
<p>  # if we haven't seen the CD, create an empty attribute hash<br />
  if !pivoted.keys.include?(id)<br />
    pivoted[id] = Hash.new<br />
  end</p>
<p>  # add the new attribute<br />
  pivoted[id][attribute_key] = attribute<br />
end</p>
<p># make data into 2d array<br />
table = Array.new<br />
pivoted.keys.each do |e|<br />
  heading = Array.new<br />
  heading &lt;&lt; "ID"<br />
  pivoted[e].keys.each do |sub_e|<br />
    heading &lt;&lt; sub_e.to_s.upcase<br />
  end<br />
  table &lt;&lt; heading<br />
  # only need first row of heading<br />
  break<br />
end</p>
<p>pivoted.keys.each do |e|<br />
  row = Array.new<br />
  row &lt;&lt; e<br />
  pivoted[e].values.each do |sub_e|<br />
    row &lt;&lt; sub_e<br />
  end<br />
  table &lt;&lt; row<br />
end</p>
<p># biggest size of key<br />
max_lengths = []<br />
table.each_with_index do |x|<br />
  i = 0<br />
  x.each_with_index do |y|<br />
    if max_lengths[i].nil? || y.to_s.length &gt; max_lengths[i]<br />
      max_lengths[i] = y.to_s.length<br />
    end<br />
    i += 1<br />
  end<br />
end</p>
<p>puts "Pivoted Labeled:"<br />
line_size = max_lengths.inject{|sum,x| sum + x } + max_lengths.length * 3 - 1<br />
puts "-" * line_size</p>
<p># pad columns with spaces and bars from max_lengths<br />
table.each_with_index do |x|<br />
  string = ""<br />
  i = 0<br />
  x.each_with_index do |y|<br />
    string &lt;&lt; y.to_s.ljust(max_lengths[i]) &lt;&lt; " | "<br />
    i += 1<br />
  end</p>
<p>  puts string<br />
end</p>
<p># spacer<br />
puts ""<br />
</p>
<p>This code will produce this text:</p>
<pre>Pivoted Labeled:<br />
-------------------------------------------------------------------<br />
ID       | ARTIST         | GENRE       | YEAR | ALBUM            |<br />
a70eb30d | DJ Shadow      | electronica | 1996 | Endtroducing     |<br />
090e6012 | The Avalanches | electronica | 2000 | Since I Left You |<br />
</pre>
<h3>Conclusion</h3><br />
Both examples are very procedural.  There might be opportunities to make this code more OO or even functional by breaking up common tasks.  However, the problem I ran into was of the structure itself.  I don't see a generic way of creating code reuse except for creating methods that can handle a "hash of hashes" or other pre-defined types.  I wanted to post a copy and paste template that would help anyone out there trying to pivot data (or even find this name for a problem like this) but unfortunately the solutions are tightly bound to the data structure you are starting out with.  In the case of database rows, example #1 will probably work for you with minimal changes.
</pre></pre>

  </article>

</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">Squarism</h2>

    <div class="footer-col-1 column">
      <ul>
        <li>Squarism</li>
        <li><a href="mailto:squarism@gmail.com">squarism@gmail.com</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/squarism">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username">squarism</span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/squarism">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username">squarism</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">A tech blog about ruby, code, mongodb, golang and other stuff.</p>
    </div>

  </div>

</footer>


    </body>
</html>
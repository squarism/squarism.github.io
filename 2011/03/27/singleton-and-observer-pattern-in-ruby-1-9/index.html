<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Singleton and Observer Pattern in Ruby 1.9</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="A tech blog about ruby, code, mongodb, golang and other stuff.">
    <link rel="canonical" href="http://squarism.com//2011/03/27/singleton-and-observer-pattern-in-ruby-1-9/">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/">Squarism</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          <a class="page-link" href="/about/">About</a>
        
          
        
          
        
          <a class="page-link" href="/about/index.html">About</a>
        
          <a class="page-link" href="/questions/index.html">Questions I Have</a>
        
          <a class="page-link" href="/tatris/index.html">Tatris - A Tetris Clone</a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Singleton and Observer Pattern in Ruby 1.9</h1>
    <p class="meta">Mar 27, 2011 • Posted by: chris</p>
  </header>

  <article class="post-content">
  <p><img src="http://squarism.com/wp-content/uploads/2011/03/god_pix-150x150.png" alt="" title="god_pix" width="150" height="150" class="alignright size-thumbnail wp-image-1105" /><br />
<em>This post isn't specific to Ruby 1.9, I just want to differentiate this a little bit from other examples out there.</em></p>
<h2>First cut of singleton</h2>
<p><br />
A while ago, I wrote a singleton class as a proof of concept.  It turns out that this was the hard way.  Since then, I’ve just used the Singleton Mixin instead of writing it by hand.  For this post, I’ll talk about both.  First off, what we’re going to create is a God class which, other than starting a quite dangerous religious debate, will illustrate a singleton object and how to work within and outside it.&lt;/p&gt;</p>
<p>The first example is very contrived.  We'll create a God class and define a metaclass with <code>class &lt;&lt; self</code> which will keep us from creating a God instance with God.new and instead will force use to refer to only one God.  So essentially, any properties within that block will be constrained to one single instance.  Anything outside it, is a normal instance.</p>
<p>Like I said, this is pretty old code and so it doesn't flow all that well.  First, we create the God class as a singleton because we'll just declare that all religions are about the same big guy (as an example).  It has instance variables like name, religion and soul because God doesn't have one name.  Everyone calls him something different.  This is also true for religion.  Soul as an instance variable of God actually doesn't make much sense.  But it does allow us to track what "humans" there are.  In the next example, this will be clearer.<br />
<a id="more"></a><a id="more-1098"></a><br />
So we create a God (line 5), create some souls in a hash just for brevity and ease of typing (line 44).  Next, on line 50, we collect up all the gods so we can find some instances of it.  We have some put statements on 55 and 56 just showing that .name is not in the singleton.</p>
<p>Now we change state on 59.  God.mood will set the mood for everyone's God.  So essentially Frank ruined it for everyone.  :)  We'll also set God.rapture here although this is contrived design.</p>
<p>Lastly, we print out some more messages to show that God got mad.</p>
<pre lang="ruby" line="1"># this is the hard way, use include Singleton for easier way<br />
require 'pp'
<p># playing god with singletons<br />
class God</p>
<p>  # people have different names and religions for the same big guy<br />
  attr_accessor :name<br />
  attr_accessor :religion<br />
  attr_accessor :soul</p>
<p>  def initialize(soul, name, religion)<br />
    self.name = name<br />
    self.religion = religion<br />
    self.soul = soul<br />
    God.souls.push soul</p>
<p>    God.rapture = false<br />
    God.mood = "Sanctimonious"<br />
  end</p>
<p>  # but the big guy only has one mood and rapture state<br />
  class &lt;&lt; self<br />
    attr_accessor :mood<br />
    attr_accessor :rapture<br />
    attr_accessor :souls<br />
    def rapture?<br />
      @rapture<br />
    end</p>
<p>    def souls<br />
      @souls ||= []<br />
      @souls<br />
    end<br />
  end</p>
<p>end</p>
<p># printy helper<br />
def god_status<br />
  "God's mood:#{God.mood} and #{God.rapture? ? 'RAPTURE!!' : 'no rapture.'}"<br />
end</p>
<p>souls = [<br />
  { :name =&gt; "Sally", :god =&gt; "God", :religion =&gt; "Christian" },<br />
  { :name =&gt; "Frank", :god =&gt; "Buddha", :religion =&gt; "Buddhist" },<br />
  { :name =&gt; "Pat", :god =&gt; "Deus", :religion =&gt; "Pagan" }<br />
]</p>
<p>gods = souls.collect {|s| God.new(s[:name], s[:god], s[:religion]) }</p>
<p>sally_god = gods.find {|g| g.soul == "Sally"}<br />
frank_god = gods.find {|g| g.soul == "Frank"}</p>
<p>puts "Sally, a #{sally_god.religion}, calls God #{sally_god.name}. #{god_status}"<br />
puts "Frank, a #{frank_god.religion}, calls God #{frank_god.name}. #{god_status}"</p>
<p>puts "*** God gets pissed at Frank. ***"<br />
God.mood = "Pissed"<br />
God.rapture = true</p>
<p>puts "Sally, a #{sally_god.religion}, calls God #{sally_god.name}. #{god_status}"<br />
puts "Frank, a #{frank_god.religion}, calls God #{frank_god.name}. #{god_status}"<br />
puts "Pat, a #{pat_god.religion}, calls God #{pat_god.name}. #{god_status}"<br />
</p>
<p>Running this gives us:<br />
<code><br />
Sally, a Christian, calls God God. God's mood:Sanctimonious and no rapture.<br />
Frank, a Buddhist, calls God Buddha. God's mood:Sanctimonious and no rapture.<br />
*** God gets pissed at Frank. ***<br />
Sally, a Christian, calls God God. God's mood:Pissed and RAPTURE!!<br />
Frank, a Buddhist, calls God Buddha. God's mood:Pissed and RAPTURE!!<br />
Pat, a Pagan, calls God Deus. God's mood:Pissed and RAPTURE!!</code></p>
<p>Ok, pretty procedural and contrived.  We can do better.</p>
<h2>Refactor</h2><br />
Before showing this example, I should say that <a href="http://www.amazon.com/First-Design-Patterns-Elisabeth-Freeman/dp/0596007124">Head First Design Patterns</a> is a great read and one of the very first lessons is <em>not to use design patterns just to use them</em>.  That being said, we'll be refactoring our singleton but also introducing a new pattern the Observer.  This will make our code less procedural and will react to events.
<p>First off, we'll create a Universe class which will own the rapture state.  God doesn't really own the rapture, he might invoke it but it's a state of the universe (or earth or whatever).  We'll change our God class to <code>include Singleton</code> instead of writing the <code>class &lt;&lt; self</code> bit and by doing that, we'll still not be able to call God.new.  Instead, you'll call God.instance to get the single reference of God.  We will move god_status into the God class, to avoid a global method.  We just use god_status for feedback on the console as to what's going on.  Also note that universe is a singleton because there's only one Universe.  :)</p>
<p>Next, we'll move our humans into a class called Soul.  Souls have attributes like our souls array before but now has a method commit_sin().  In commit_sin, we notify our observers, which is always just God, and we also pass the old state as a hash.  Now, this is a bit clunky.  First off, :sinned_was is not that clear.  The idea I had here was if you wanted God to do a switch() on old state or something, you could pass in the old state to the observer.  Normally, only the current state of the object is passed because you're doing a <code>notify_observers(self)</code>.  Self will be the current state of that object.  So even though it might be brittle design, I wanted to show that you could pass the old state to an Observer to make a decision or something.  In this case, I'm checking to see if the old sin count was 0 to give someone a second chance.  I could just as easily check to see if the current count is 1 but I'm illustrating options here.  The option to do something more specific could be handy.  The observer pattern only really fires on the entire object.  For example, if we wanted the rapture to start no matter what if someone changes religion, then we could do something like this:</p>
<pre lang="ruby">
# more precise observation/update<br />
# in Soul, send the old state<br />
notify_observers(self, {:religion_was =&gt; old_religion})<br />
# in God, see if someone changed religion<br />
if args[:religion_was] != soul.religion<br />
  # if so, start the rapture, God doesn't allow conversions.  :)<br />
end<br />
</pre>
<p>A more real-world example would be something that doesn't just react to count but more of a workflow.  Like, if I only lock an account if they have a failed login count of 3 but also have been warned 2 times.  I'd want to be more precise as to what I'm checking for in update().</p>
<p>The other big change is the addition of the <code>include Observable</code> in both the Universe and Soul class.  What this means is that these classes are going to be observed by another class.  When another class changes state, the update() method will be called by the Subject.  Put it another way:</p>
<blockquote><p>
Universe is Observable by a Soul (a person sees the world around them).<br />
If the rapture happens, Universe goes nuts and thus notifies its observers (Souls).<br />
When it notifies, it sends a reference of itself.<br />
Soul.update is called and people do something (like panic).<br />
</p></blockquote>
<p>So here's the refactored Singleton example with Observers thrown in.</p>
<pre lang="ruby" line="1"># a better way to do the original<br />
require 'pp'<br />
require 'observer'<br />
require 'singleton'
<p># There is only one Universe<br />
class Universe<br />
  include Singleton<br />
  include Observable</p>
<p>  attr_accessor :rapture</p>
<p>  def initialize<br />
    @rapture = false<br />
  end</p>
<p>  # when the universe changes, people notice  :)<br />
  def rapture=(state)<br />
    @rapture = state<br />
    changed<br />
    notify_observers(self)<br />
  end</p>
<p>end</p>
<p># There is only one God<br />
class God<br />
  include Singleton</p>
<p>  # people have different names and religions for the same big guy<br />
  attr_accessor :name<br />
  attr_accessor :mood<br />
  attr_reader   :mankinds_transgressions</p>
<p>  def initialize<br />
    @name = "God"<br />
    @mood = "Sanctimonious"<br />
    @mankinds_transgressions = 0<br />
  end</p>
<p>  def mood=(mood)<br />
    @mood = mood<br />
    if mood == "pissed"<br />
      Universe.instance.rapture = true<br />
    end<br />
  end</p>
<p>  # printy helper<br />
  def god_status<br />
    print "God's mood:#{God.mood} and rapture is "<br />
    puts "#{God.rapture? ? 'ON! AAAHHH!' : 'not happening, whew.'}"<br />
  end</p>
<p>  def mankinds_transgressions=(count)<br />
    @mankinds_transgressions += 1<br />
    puts "Mankind sins: #{@mankinds_transgressions}"<br />
    if @mankinds_transgressions &gt;= 3<br />
      self.mood="pissed"<br />
    end<br />
  end</p>
<p>  # create a new person and really just add an observer<br />
  def birth(soul)<br />
    # God observes a person<br />
    soul.add_observer(self)</p>
<p>    # People observe the universe<br />
    Universe.instance.add_observer(soul)<br />
  end</p>
<p>  # a soul changed, probably a person sinning<br />
  def update(soul, args={})<br />
    puts "#{soul.name} sinned."<br />
    if !args.empty?<br />
      if args.has_key? :sinned_was</p>
<p>        # yes, there's an easier way to do this by just looking at the soul.sin<br />
        # but this is for flexibility and example<br />
        if args[:sinned_was] == 0<br />
          puts "God: First time offense for #{soul.name}.  I forgive."<br />
        else<br />
          self.mankinds_transgressions = @mankinds_transgressions + 1<br />
        end<br />
      end<br />
    end</p>
<p>  end</p>
<p>end</p>
<p>class Soul<br />
  include Observable<br />
  attr_reader :name<br />
  attr_reader :god<br />
  attr_reader :religion<br />
  attr_reader :sin</p>
<p>  def initialize(name, god, religion)<br />
    @name = name<br />
    @god = god<br />
    @religion = religion<br />
    @sin = 0<br />
  end</p>
<p>  def commit_sin<br />
    old_sin = @sin<br />
    @sin += 1<br />
    changed<br />
    notify_observers(self, {:sinned_was =&gt; old_sin})<br />
  end</p>
<p>  # People watch the universe<br />
  def update(universe)<br />
    print "#{self.name} sees that he universe changed.  "<br />
    puts "And thinks #{self.god} did it.  Rapture: #{universe.rapture}"<br />
  end</p>
<p>end</p>
<p>sally = Soul.new("Sally", "God", "Christianity")<br />
frank = Soul.new("Frank", "Buddha", "Buddhism")<br />
pat = Soul.new("Pat", "Deus", "Paganism")</p>
<p>God.instance.birth sally<br />
God.instance.birth frank<br />
God.instance.birth pat</p>
<p>puts "God's mood is #{God.instance.mood}."</p>
<p>sally.commit_sin</p>
<p>frank.commit_sin<br />
frank.commit_sin<br />
frank.commit_sin</p>
<p>pat.commit_sin<br />
pat.commit_sin<br />
puts "God's mood is #{God.instance.mood}."<br />
</p>
<p>The pay-off with all this code is in the main method.  You'll notice that lines 119 and down (the main) are very easy to read.  All the wiring has already been done and we can just interact with the objects very plainly.  We don't have to fire events, we don't have to care about the internal state.  We can simply commit sins and the universe goes into rapture (in this case, after three non first time sins have been committed).</p>
<p><code>God's mood is Sanctimonious.<br />
Sally sinned.<br />
God: First time offense for Sally.  I forgive.<br />
Frank sinned.<br />
God: First time offense for Frank.  I forgive.<br />
Frank sinned.<br />
Mankind sins: 1<br />
Frank sinned.<br />
Mankind sins: 2<br />
Pat sinned.<br />
God: First time offense for Pat.  I forgive.<br />
Pat sinned.<br />
Mankind sins: 3<br />
Sally sees that he universe changed.  And thinks God did it.  Rapture: true<br />
Frank sees that he universe changed.  And thinks Buddha did it.  Rapture: true<br />
Pat sees that he universe changed.  And thinks Deus did it.  Rapture: true<br />
God's mood is pissed.<br />
</code></p>
<h2>Real World</h2><br />
So how would you really use this?  Well, I've used it for a Config class which there should only be one of.  My Config object can read a file once on load and I never have to worry about it hitting the filesystem excessively, if I want that.  You can also use it for a layer between you and a piece of data.  Like a database pool or a web proxy.  If you had a Proxy class, you could throttle the connection speed to a web service and avoid going over an API rate limit.  With a singleton, your Proxy could keep track of all connections, rates and bandwidth totals internally instead of pushing this problem to the database.
<p>Any problem you solve, definitely use the built-in Singleton Mixin.  It's easier to implement and you don't have to maintain it.</p>
</pre></pre>

  </article>

</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">Squarism</h2>

    <div class="footer-col-1 column">
      <ul>
        <li>Squarism</li>
        <li><a href="mailto:squarism@gmail.com">squarism@gmail.com</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/squarism">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username">squarism</span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/squarism">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username">squarism</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">A tech blog about ruby, code, mongodb, golang and other stuff.</p>
    </div>

  </div>

</footer>


    </body>
</html>